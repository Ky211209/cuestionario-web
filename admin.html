<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Panel Admin - UNEMI</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>
    <header>
        <div class="logo"><h1>Panel Admin <span class="subtitle">UNEMI</span></h1></div>
        <div style="display: flex; gap: 15px; align-items: center;">
            <span id="admin-name" style="font-weight: bold; color: #1a73e8;"></span>
            <button onclick="window.location.href='index.html'" class="btn-secondary">Volver al Simulador</button>
            <button id="btn-admin-logout" class="btn-secondary">Cerrar Sesión</button>
        </div>
    </header>

    <div class="container" style="margin-top: 30px; max-width: 800px;">
        <nav style="display: flex; justify-content: center; gap: 10px; margin-bottom: 25px;">
            <button onclick="changeTab('tab-excel')" id="btn-tab-excel" class="btn-secondary">Cargar Excel</button>
            <button onclick="changeTab('tab-users')" id="btn-tab-users" class="btn-secondary">Gestionar Alumnos</button>
        </nav>

        <div id="tab-excel">
            <h3>Carga Masiva de Preguntas (Con Actualización Automática)</h3>
            <p style="font-size: 0.85em; color: #666; margin-bottom: 10px;">
                Si la pregunta ya existe, se actualizarán sus opciones y la <strong>explicación</strong>.
            </p>
            <input type="file" id="upload-excel" accept=".xlsx" style="margin: 20px 0;">
            <button id="btn-save-excel" class="btn-primary">Procesar y Sincronizar con Firebase</button>
        </div>

        <div id="tab-users" class="hidden">
            <h3>Gestión de Alumnos (CRUD)</h3>
            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                <input type="email" id="edit-email" placeholder="correo@unemi.edu.ec" style="width: 100%; padding: 10px; border-radius: 5px; border: 1px solid #ddd; margin-bottom: 10px;">
                <select id="edit-limit" style="width: 100%; padding: 10px; border-radius: 5px; border: 1px solid #ddd; margin-bottom: 10px;">
                    <option value="1">1 Dispositivo</option>
                    <option value="2">2 Dispositivos</option>
                </select>
                <button id="btn-update-user" class="btn-primary">Guardar / Actualizar Alumno</button>
            </div>
            <table>
                <thead><tr><th>Correo</th><th>Disp.</th><th>Acciones</th></tr></thead>
                <tbody id="user-table-body"></tbody>
            </table>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, deleteDoc, collection, getDocs, writeBatch, query, where } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyAMQpnPJSdicgo5gungVOE0M7OHwkz4P9Y", authDomain: "autenticacion-8faac.firebaseapp.com", projectId: "autenticacion-8faac", storageBucket: "autenticacion-8faac.firebasestorage.app", appId: "1:939518706600:web:d28c3ec7de21da8379939d" };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const ADMIN_EMAIL = "kholguinb2@unemi.edu.ec";

        onAuthStateChanged(auth, (user) => { 
            if(user) {
                if(user.email.toLowerCase() !== ADMIN_EMAIL) {
                    Swal.fire({ icon: 'error', title: 'Acceso Denegado' }).then(() => {
                        signOut(auth).then(() => window.location.href = 'index.html');
                    });
                    return;
                }
                document.getElementById('admin-name').innerText = user.displayName.toUpperCase();
            } else {
                window.location.href = 'index.html';
            }
        });

        let dataExcel = [];
        
        function validarEstructuraExcel(data) {
            if (!data || data.length === 0) return { valido: false, mensaje: 'El archivo está vacío.' };
            const requeridos = ['materia_id', 'texto', 'opcion_0', 'opcion_1', 'opcion_2', 'opcion_3', 'respuesta'];
            for (let i = 0; i < data.length; i++) {
                for (const campo of requeridos) {
                    if (!(campo in data[i]) || data[i][campo] === undefined || data[i][campo] === '') {
                        return { valido: false, mensaje: `Fila ${i + 2}: Falta el campo "${campo}".` };
                    }
                }
            }
            return { valido: true };
        }

        document.getElementById('upload-excel').onchange = (e) => {
            const file = e.target.files[0];
            const reader = new FileReader();
            reader.onload = (ev) => {
                try {
                    const wb = XLSX.read(new Uint8Array(ev.target.result), {type:'array'});
                    const tempData = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
                    const val = validarEstructuraExcel(tempData);
                    if (!val.valido) {
                        Swal.fire('Error de Plantilla', val.mensaje, 'error');
                        e.target.value = '';
                    } else {
                        dataExcel = tempData;
                        Swal.fire('Éxito', 'Archivo cargado y validado.', 'success');
                    }
                } catch (err) {
                    Swal.fire('Error', 'No se pudo leer el archivo.', 'error');
                }
            };
            reader.readAsArrayBuffer(file);
        };

        document.getElementById('btn-save-excel').onclick = async () => {
            if(dataExcel.length === 0) return Swal.fire('Error', 'Carga un archivo Excel primero.', 'warning');

            Swal.fire({
                title: 'Sincronizando...',
                text: 'Actualizando base de datos en Firebase',
                allowOutsideClick: false,
                didOpen: () => { Swal.showLoading(); }
            });

            try {
                const batch = writeBatch(db);
                let nuevas = 0;
                let actualizadas = 0;

                for (const p of dataExcel) {
                    const colRef = collection(db, `bancos_preguntas/${p.materia_id}/preguntas`);
                    const q = query(colRef, where("texto", "==", p.texto.trim()));
                    const snap = await getDocs(q);

                    let ref;
                    if (!snap.empty) {
                        // Si existe, usamos el ID del documento encontrado para sobreescribirlo/actualizarlo
                        ref = doc(db, `bancos_preguntas/${p.materia_id}/preguntas`, snap.docs[0].id);
                        actualizadas++;
                    } else {
                        // Si no existe, creamos un ID nuevo
                        ref = doc(db, `bancos_preguntas/${p.materia_id}/preguntas`, `p_${Date.now()}_${Math.random().toString(36).substr(2, 5)}`);
                        nuevas++;
                    }

                    batch.set(ref, { 
                        texto: p.texto.trim(), 
                        opciones: [
                            p.opcion_0.toString().trim(), 
                            p.opcion_1.toString().trim(), 
                            p.opcion_2.toString().trim(), 
                            p.opcion_3.toString().trim()
                        ], 
                        respuesta: parseInt(p.respuesta),
                        // ASIGNACIÓN CLAVE: Aquí tomamos 'explicacion' del Excel y lo guardamos como 'explicacion_correcta'
                        explicacion_correcta: p.explicacion ? p.explicacion.toString().trim() : "Consulte el material de estudio oficial."
                    });
                }

                await batch.commit();
                Swal.fire('Proceso Terminado', `Preguntas Nuevas: ${nuevas}<br>Preguntas Actualizadas: ${actualizadas}`, 'success');
                dataExcel = [];
                document.getElementById('upload-excel').value = '';

            } catch (error) {
                console.error(error);
                Swal.fire('Error Crítico', 'No se pudo completar la sincronización.', 'error');
            }
        };

        async function loadUsers() {
            const body = document.getElementById('user-table-body');
            body.innerHTML = "";
            const snap = await getDocs(collection(db, "usuarios_seguros"));
            snap.forEach(d => {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td>${d.id}</td><td>${d.data().max_dispositivos}</td><td>
                    <button onclick="window.prepareEdit('${d.id}', ${d.data().max_dispositivos})" class="btn-edit"><i class="fas fa-edit"></i></button>
                    <button onclick="window.confirmDelete('${d.id}')" class="btn-delete"><i class="fas fa-trash"></i></button></td>`;
                body.appendChild(tr);
            });
        }

        window.prepareEdit = (email, limit) => {
            document.getElementById('edit-email').value = email;
            document.getElementById('edit-limit').value = limit;
        };

        window.confirmDelete = (email) => {
            Swal.fire({ title: '¿Eliminar usuario?', icon: 'warning', showCancelButton: true }).then(async (r) => {
                if(r.isConfirmed) { await deleteDoc(doc(db, "usuarios_seguros", email)); loadUsers(); }
            });
        };

        document.getElementById('btn-update-user').onclick = async () => {
            const email = document.getElementById('edit-email').value.trim().toLowerCase();
            if(!email) return;
            await setDoc(doc(db, "usuarios_seguros", email), { max_dispositivos: parseInt(document.getElementById('edit-limit').value) });
            Swal.fire('Éxito', 'Información actualizada.', 'success'); loadUsers();
        };

        window.changeTab = (id) => {
            document.getElementById('tab-excel').classList.toggle('hidden', id !== 'tab-excel');
            document.getElementById('tab-users').classList.toggle('hidden', id !== 'tab-users');
            if(id === 'tab-users') loadUsers();
        };

        document.getElementById('btn-admin-logout').onclick = () => {
            if(confirm("¿Seguro que desea salir?")) signOut(auth).then(() => location.href='index.html');
        };
    </script>
</body>
</html>
