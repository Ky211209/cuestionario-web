<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Panel Admin - UNEMI</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>
    <header>
        <div class="logo"><h1>Panel Admin <span class="subtitle">UNEMI</span></h1></div>
        <div style="display: flex; gap: 15px; align-items: center;">
            <span id="admin-name" style="font-weight: bold; color: #1a73e8;"></span>
            <button onclick="window.location.href='index.html'" class="btn-secondary">Volver al Simulador</button>
            <button id="btn-admin-logout" class="btn-secondary">Cerrar Sesi√≥n</button>
        </div>
    </header>

    <div class="container" style="margin-top: 30px; max-width: 800px;">
        <nav style="display: flex; justify-content: center; gap: 10px; margin-bottom: 25px;">
            <button onclick="changeTab('tab-excel')" id="btn-tab-excel" class="btn-secondary">Cargar Excel</button>
            <button onclick="changeTab('tab-users')" id="btn-tab-users" class="btn-secondary">Gestionar Alumnos</button>
            <button onclick="changeTab('tab-auditoria')" id="btn-tab-auditoria" class="btn-secondary">üìã Auditor√≠a</button>
        </nav>

        <div id="tab-excel">
            <h3>Carga Masiva de Preguntas (Con Actualizaci√≥n Autom√°tica)</h3>
            <p style="font-size: 0.85em; color: #666; margin-bottom: 10px;">
                Si la pregunta ya existe, se actualizar√°n sus opciones y la <strong>explicaci√≥n</strong>.
            </p>
            <input type="file" id="upload-excel" accept=".xlsx" style="margin: 20px 0;">
            <button id="btn-save-excel" class="btn-primary">Procesar y Sincronizar con Firebase</button>
        </div>

        <div id="tab-users" class="hidden">
            <h3>Gesti√≥n de Alumnos (CRUD)</h3>
            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                <input type="email" id="edit-email" placeholder="correo@unemi.edu.ec" style="width: 100%; padding: 10px; border-radius: 5px; border: 1px solid #ddd; margin-bottom: 10px;">
                <select id="edit-limit" style="width: 100%; padding: 10px; border-radius: 5px; border: 1px solid #ddd; margin-bottom: 10px;">
                    <option value="1">1 Dispositivo</option>
                    <option value="2">2 Dispositivos</option>
                </select>
                <button id="btn-update-user" class="btn-primary">Guardar / Actualizar Alumno</button>
            </div>
            <table>
                <thead><tr><th>Correo</th><th>Disp.</th><th>Acciones</th></tr></thead>
                <tbody id="user-table-body"></tbody>
            </table>
        </div>
        <div id="tab-auditoria" class="hidden">
            <h3>üìã Reporte de Auditor√≠a</h3>
            <p style="font-size: 0.85em; color: #666; margin-bottom: 15px;">
                Registro de accesos, preguntas vistas e intentos sospechosos de todos los alumnos.
            </p>

            <!-- FILTROS -->
            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px; display: flex; flex-wrap: wrap; gap: 10px; align-items: flex-end;">
                <div style="flex: 1; min-width: 160px;">
                    <label style="font-size: 0.8rem; font-weight: bold; display: block; margin-bottom: 4px;">Usuario (email)</label>
                    <input type="text" id="filtro-email" placeholder="Filtrar por email..." style="width: 100%; padding: 8px; border-radius: 5px; border: 1px solid #ddd; font-size: 0.85rem;">
                </div>
                <div style="flex: 1; min-width: 130px;">
                    <label style="font-size: 0.8rem; font-weight: bold; display: block; margin-bottom: 4px;">Tipo de evento</label>
                    <select id="filtro-tipo" style="width: 100%; padding: 8px; border-radius: 5px; border: 1px solid #ddd; font-size: 0.85rem;">
                        <option value="">Todos</option>
                        <option value="inicio_sesion">Inicio sesi√≥n</option>
                        <option value="ver_pregunta">Ver pregunta</option>
                        <option value="perder_foco">Perder foco</option>
                        <option value="intento_inspeccionar">Intento inspeccionar</option>
                        <option value="intento_captura_pantalla">Intento captura</option>
                    </select>
                </div>
                <div style="display: flex; gap: 8px;">
                    <button id="btn-filtrar" class="btn-primary" style="padding: 8px 16px; font-size: 0.85rem;">üîç Filtrar</button>
                    <button id="btn-exportar-excel" class="btn-secondary" style="padding: 8px 16px; font-size: 0.85rem;">üì• Exportar Excel</button>
                    <button id="btn-limpiar-filtros" class="btn-secondary" style="padding: 8px 16px; font-size: 0.85rem;">‚úñ Limpiar</button>
                </div>
            </div>

            <!-- RESUMEN -->
            <div id="auditoria-resumen" style="display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 15px;"></div>

            <!-- TABLA -->
            <div style="overflow-x: auto;">
                <table id="tabla-auditoria">
                    <thead>
                        <tr>
                            <th>Fecha / Hora</th>
                            <th>Usuario</th>
                            <th>Tipo de Evento</th>
                            <th>Detalle</th>
                        </tr>
                    </thead>
                    <tbody id="auditoria-table-body">
                        <tr><td colspan="4" style="text-align:center; color:#aaa; padding: 30px;">Cargando registros...</td></tr>
                    </tbody>
                </table>
            </div>
            <p id="auditoria-count" style="font-size: 0.8rem; color: #888; margin-top: 10px; text-align: right;"></p>
        </div>
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, deleteDoc, collection, getDocs, writeBatch, query, where, orderBy, limit } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyAMQpnPJSdicgo5gungVOE0M7OHwkz4P9Y", authDomain: "autenticacion-8faac.firebaseapp.com", projectId: "autenticacion-8faac", storageBucket: "autenticacion-8faac.firebasestorage.app", appId: "1:939518706600:web:d28c3ec7de21da8379939d" };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const ADMIN_EMAIL = "kholguinb2@unemi.edu.ec";

        onAuthStateChanged(auth, (user) => { 
            if(user) {
                if(user.email.toLowerCase() !== ADMIN_EMAIL) {
                    Swal.fire({ icon: 'error', title: 'Acceso Denegado' }).then(() => {
                        signOut(auth).then(() => window.location.href = 'index.html');
                    });
                    return;
                }
                document.getElementById('admin-name').innerText = user.displayName.toUpperCase();
            } else {
                window.location.href = 'index.html';
            }
        });

        let dataExcel = [];
        
        function validarEstructuraExcel(data) {
            if (!data || data.length === 0) return { valido: false, mensaje: 'El archivo est√° vac√≠o.' };
            const requeridos = ['materia_id', 'texto', 'opcion_0', 'opcion_1', 'opcion_2', 'opcion_3', 'respuesta'];
            for (let i = 0; i < data.length; i++) {
                for (const campo of requeridos) {
                    if (!(campo in data[i]) || data[i][campo] === undefined || data[i][campo] === '') {
                        return { valido: false, mensaje: `Fila ${i + 2}: Falta el campo "${campo}".` };
                    }
                }
            }
            return { valido: true };
        }

        document.getElementById('upload-excel').onchange = (e) => {
            const file = e.target.files[0];
            const reader = new FileReader();
            reader.onload = (ev) => {
                try {
                    const wb = XLSX.read(new Uint8Array(ev.target.result), {type:'array'});
                    const tempData = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
                    const val = validarEstructuraExcel(tempData);
                    if (!val.valido) {
                        Swal.fire('Error de Plantilla', val.mensaje, 'error');
                        e.target.value = '';
                    } else {
                        dataExcel = tempData;
                        Swal.fire('√âxito', 'Archivo cargado y validado.', 'success');
                    }
                } catch (err) {
                    Swal.fire('Error', 'No se pudo leer el archivo.', 'error');
                }
            };
            reader.readAsArrayBuffer(file);
        };

        document.getElementById('btn-save-excel').onclick = async () => {
            if(dataExcel.length === 0) return Swal.fire('Error', 'Carga un archivo Excel primero.', 'warning');

            Swal.fire({
                title: 'Sincronizando...',
                text: 'Actualizando base de datos en Firebase',
                allowOutsideClick: false,
                didOpen: () => { Swal.showLoading(); }
            });

            try {
                const batch = writeBatch(db);
                let nuevas = 0;
                let actualizadas = 0;

                for (const p of dataExcel) {
                    const colRef = collection(db, `bancos_preguntas/${p.materia_id}/preguntas`);
                    const q = query(colRef, where("texto", "==", p.texto.trim()));
                    const snap = await getDocs(q);

                    let ref;
                    if (!snap.empty) {
                        // Si existe, usamos el ID del documento encontrado para sobreescribirlo/actualizarlo
                        ref = doc(db, `bancos_preguntas/${p.materia_id}/preguntas`, snap.docs[0].id);
                        actualizadas++;
                    } else {
                        // Si no existe, creamos un ID nuevo
                        ref = doc(db, `bancos_preguntas/${p.materia_id}/preguntas`, `p_${Date.now()}_${Math.random().toString(36).substr(2, 5)}`);
                        nuevas++;
                    }

                    batch.set(ref, { 
                        texto: p.texto.trim(), 
                        opciones: [
                            p.opcion_0.toString().trim(), 
                            p.opcion_1.toString().trim(), 
                            p.opcion_2.toString().trim(), 
                            p.opcion_3.toString().trim()
                        ], 
                        respuesta: parseInt(p.respuesta),
                        // ASIGNACI√ìN CLAVE: Aqu√≠ tomamos 'explicacion' del Excel y lo guardamos como 'explicacion_correcta'
                        explicacion_correcta: p.explicacion ? p.explicacion.toString().trim() : "Consulte el material de estudio oficial."
                    });
                }

                await batch.commit();
                Swal.fire('Proceso Terminado', `Preguntas Nuevas: ${nuevas}<br>Preguntas Actualizadas: ${actualizadas}`, 'success');
                dataExcel = [];
                document.getElementById('upload-excel').value = '';

            } catch (error) {
                console.error(error);
                Swal.fire('Error Cr√≠tico', 'No se pudo completar la sincronizaci√≥n.', 'error');
            }
        };

        async function loadUsers() {
            const body = document.getElementById('user-table-body');
            body.innerHTML = "";
            const snap = await getDocs(collection(db, "usuarios_seguros"));
            snap.forEach(d => {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td>${d.id}</td><td>${d.data().max_dispositivos}</td><td>
                    <button onclick="window.prepareEdit('${d.id}', ${d.data().max_dispositivos})" class="btn-edit"><i class="fas fa-edit"></i></button>
                    <button onclick="window.confirmDelete('${d.id}')" class="btn-delete"><i class="fas fa-trash"></i></button></td>`;
                body.appendChild(tr);
            });
        }

        window.prepareEdit = (email, limit) => {
            document.getElementById('edit-email').value = email;
            document.getElementById('edit-limit').value = limit;
        };

        window.confirmDelete = (email) => {
            Swal.fire({ title: '¬øEliminar usuario?', icon: 'warning', showCancelButton: true }).then(async (r) => {
                if(r.isConfirmed) { await deleteDoc(doc(db, "usuarios_seguros", email)); loadUsers(); }
            });
        };

        document.getElementById('btn-update-user').onclick = async () => {
            const email = document.getElementById('edit-email').value.trim().toLowerCase();
            if(!email) return;
            await setDoc(doc(db, "usuarios_seguros", email), { max_dispositivos: parseInt(document.getElementById('edit-limit').value) });
            Swal.fire('√âxito', 'Informaci√≥n actualizada.', 'success'); loadUsers();
        };

        // ================================================================
        // M√ìDULO DE AUDITOR√çA
        // ================================================================
        let todosLosRegistros = [];

        const TIPO_LABELS = {
            'inicio_sesion':            { label: 'üîê Inicio de Sesi√≥n',    color: '#1a73e8' },
            'ver_pregunta':             { label: 'üëÅÔ∏è Ver Pregunta',         color: '#34a853' },
            'perder_foco':              { label: '‚ö†Ô∏è Perdi√≥ Foco',          color: '#fbbc04' },
            'intento_inspeccionar':     { label: 'üö® Intento Inspeccionar', color: '#ea4335' },
            'intento_captura_pantalla': { label: 'üì∏ Intento Captura',      color: '#ea4335' },
        };

        async function cargarAuditoria() {
            const body = document.getElementById('auditoria-table-body');
            body.innerHTML = `<tr><td colspan="4" style="text-align:center;color:#aaa;padding:30px;">Cargando registros...</td></tr>`;
            try {
                const snap = await getDocs(query(collection(db, "auditoria_accesos"), orderBy("timestamp", "desc"), limit(500)));
                todosLosRegistros = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                renderTablaAuditoria(todosLosRegistros);
            } catch(e) {
                console.error(e);
                body.innerHTML = `<tr><td colspan="4" style="text-align:center;color:#ea4335;padding:20px;">Error al cargar. Verifica los √≠ndices de Firestore.</td></tr>`;
            }
        }

        function renderTablaAuditoria(registros) {
            const body = document.getElementById('auditoria-table-body');
            const countEl = document.getElementById('auditoria-count');
            const resumenEl = document.getElementById('auditoria-resumen');
            body.innerHTML = '';

            if (registros.length === 0) {
                body.innerHTML = `<tr><td colspan="4" style="text-align:center;color:#aaa;padding:30px;">No se encontraron registros.</td></tr>`;
                countEl.innerText = '';
                resumenEl.innerHTML = '';
                return;
            }

            // Tarjetas de resumen
            const conteos = {};
            registros.forEach(r => { conteos[r.tipo] = (conteos[r.tipo] || 0) + 1; });
            resumenEl.innerHTML = Object.entries(conteos).map(([tipo, count]) => {
                const info = TIPO_LABELS[tipo] || { label: tipo, color: '#888' };
                return `<div style="background:#fff;border:1px solid #eee;border-left:4px solid ${info.color};
                    padding:8px 14px;border-radius:6px;font-size:0.82rem;">
                    <strong style="color:${info.color}">${info.label}</strong><br>
                    <span style="font-size:1.1rem;font-weight:bold;">${count}</span> registros
                </div>`;
            }).join('');

            // Filas
            registros.forEach(r => {
                const info = TIPO_LABELS[r.tipo] || { label: r.tipo, color: '#888' };
                const fecha = r.fecha_legible || (r.timestamp?.toDate ? r.timestamp.toDate().toLocaleString('es-EC') : '‚Äî');
                let detalle = '‚Äî';
                if (r.tipo === 'ver_pregunta') {
                    detalle = `<strong>${r.materia || ''}</strong> | Modo: ${r.modo || ''} | #${r.pregunta_num || ''}: "${(r.pregunta_texto || '').substring(0,50)}..."`;
                } else if (r.tipo === 'perder_foco') {
                    detalle = `Motivo: ${r.motivo || '‚Äî'}`;
                } else if (r.tipo === 'intento_inspeccionar') {
                    detalle = `Tecla: ${r.tecla || '‚Äî'}`;
                }
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td style="font-size:0.8rem;white-space:nowrap;">${fecha}</td>
                    <td style="font-size:0.8rem;">${r.usuario || '‚Äî'}</td>
                    <td><span style="background:${info.color}20;color:${info.color};padding:3px 8px;border-radius:20px;font-size:0.78rem;font-weight:600;white-space:nowrap;">${info.label}</span></td>
                    <td style="font-size:0.8rem;">${detalle}</td>`;
                body.appendChild(tr);
            });

            countEl.innerText = `Mostrando ${registros.length} registros`;
        }

        function filtrarAuditoria() {
            const emailFiltro = document.getElementById('filtro-email').value.trim().toLowerCase();
            const tipoFiltro = document.getElementById('filtro-tipo').value;
            let resultado = todosLosRegistros;
            if (emailFiltro) resultado = resultado.filter(r => (r.usuario || '').toLowerCase().includes(emailFiltro));
            if (tipoFiltro) resultado = resultado.filter(r => r.tipo === tipoFiltro);
            renderTablaAuditoria(resultado);
        }

        function exportarAExcel() {
            const emailFiltro = document.getElementById('filtro-email').value.trim().toLowerCase();
            const tipoFiltro = document.getElementById('filtro-tipo').value;
            let datos = todosLosRegistros;
            if (emailFiltro) datos = datos.filter(r => (r.usuario || '').toLowerCase().includes(emailFiltro));
            if (tipoFiltro) datos = datos.filter(r => r.tipo === tipoFiltro);
            if (datos.length === 0) return Swal.fire('Sin datos', 'No hay registros para exportar.', 'warning');

            const filas = datos.map(r => ({
                'Fecha / Hora':   r.fecha_legible || '‚Äî',
                'Usuario':        r.usuario || '‚Äî',
                'Nombre':         r.nombre || '‚Äî',
                'Tipo de Evento': TIPO_LABELS[r.tipo]?.label || r.tipo,
                'Materia':        r.materia || '‚Äî',
                'Modo':           r.modo || '‚Äî',
                'Pregunta #':     r.pregunta_num || '‚Äî',
                'Texto Pregunta': r.pregunta_texto || '‚Äî',
                'Motivo/Detalle': r.motivo || r.tecla || '‚Äî',
            }));

            const ws = XLSX.utils.json_to_sheet(filas);
            ws['!cols'] = [{ wch:22 },{ wch:30 },{ wch:25 },{ wch:25 },{ wch:20 },{ wch:12 },{ wch:10 },{ wch:50 },{ wch:20 }];
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Auditor√≠a');
            const fecha = new Date().toLocaleDateString('es-EC').replace(/\//g, '-');
            XLSX.writeFile(wb, `Auditoria_UNEMI_${fecha}.xlsx`);
        }

        document.getElementById('btn-filtrar').onclick = filtrarAuditoria;
        document.getElementById('btn-exportar-excel').onclick = exportarAExcel;
        document.getElementById('btn-limpiar-filtros').onclick = () => {
            document.getElementById('filtro-email').value = '';
            document.getElementById('filtro-tipo').value = '';
            renderTablaAuditoria(todosLosRegistros);
        };

        window.changeTab = (id) => {
            ['tab-excel', 'tab-users', 'tab-auditoria'].forEach(t => {
                document.getElementById(t).classList.toggle('hidden', t !== id);
            });
            if (id === 'tab-users') loadUsers();
            if (id === 'tab-auditoria') cargarAuditoria();
        };

        document.getElementById('btn-admin-logout').onclick = () => {
            if(confirm("¬øSeguro que desea salir?")) signOut(auth).then(() => location.href='index.html');
        };
    </script>
</body>
</html>
