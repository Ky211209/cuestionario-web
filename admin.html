<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Panel Admin - Gestión UNEMI</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>
    <header>
        <div class="logo"><h1>Panel Admin <span class="subtitle">UNEMI</span></h1></div>
        <button onclick="window.location.href='index.html'" class="btn-secondary">Volver al Simulador</button>
    </header>

    <div class="container" id="admin-main" style="max-width: 800px; margin-top: 100px;">
        <div id="tab-excel">
            <h3>Carga Masiva de Preguntas</h3>
            <p style="font-size: 0.8rem; margin-bottom: 15px;">Asegúrate que el Excel tenga la columna <b>materia_id</b>.</p>
            <input type="file" id="upload-excel" accept=".xlsx" style="margin-bottom: 20px;">
            <button id="btn-save-excel" class="btn-primary">Subir a Firebase</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
        import { getFirestore, doc, setDoc, writeBatch, collection } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyAMQpnPJSdicgo5gungVOE0M7OHwkz4P9Y", authDomain: "autenticacion-8faac.firebaseapp.com", projectId: "autenticacion-8faac", storageBucket: "autenticacion-8faac.firebasestorage.app", appId: "1:939518706600:web:d28c3ec7de21da8379939d" };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let datosExcel = [];

        document.getElementById('upload-excel').onchange = (e) => {
            const reader = new FileReader();
            reader.onload = (ev) => {
                const wb = XLSX.read(new Uint8Array(ev.target.result), {type:'array'});
                datosExcel = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
            };
            reader.readAsArrayBuffer(e.target.files[0]);
        };

        document.getElementById('btn-save-excel').onclick = async () => {
            if(datosExcel.length === 0) {
                Swal.fire('Atención', 'Primero selecciona un archivo Excel.', 'warning');
                return;
            }

            Swal.fire({
                title: 'Confirmar Carga',
                text: `¿Deseas subir ${datosExcel.length} preguntas?`,
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: 'Sí, subir'
            }).then(async (result) => {
                if (result.isConfirmed) {
                    const batch = writeBatch(db);
                    datosExcel.forEach((p, i) => {
                        // RUTA UNIFICADA: bancos_preguntas -> materia_id -> preguntas
                        const ref = doc(db, `bancos_preguntas/${p.materia_id}/preguntas`, `p_${Date.now()}_${i}`);
                        batch.set(ref, {
                            texto: p.texto,
                            opciones: [p.opcion_0, p.opcion_1, p.opcion_2, p.opcion_3],
                            respuesta: parseInt(p.respuesta),
                            explicacion: p.explicacion || ""
                        });
                    });
                    await batch.commit();
                    Swal.fire('¡Éxito!', 'Carga masiva completada correctamente.', 'success');
                }
            });
        };
    </script>
</body>
</html>
